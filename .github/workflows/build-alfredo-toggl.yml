name: Build AlfreDo-Toggl

on:
  workflow_dispatch:  # Manual trigger
    inputs:
      alfredo_version:
        description: 'AlfreDo version to build (e.g., 0.4.1, or "latest")'
        required: false
        default: 'latest'
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sunday at midnight

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Get latest AlfreDo release
        id: alfredo_release
        run: |
          if [ "${{ github.event.inputs.alfredo_version }}" == "latest" ] || [ -z "${{ github.event.inputs.alfredo_version }}" ]; then
            LATEST=$(curl -s https://api.github.com/repos/giovannicoppola/AlfreDo/releases/latest | jq -r '.tag_name')
            echo "version=$LATEST" >> $GITHUB_OUTPUT
            echo "download_url=https://github.com/giovannicoppola/AlfreDo/releases/download/$LATEST/AlfreDo_$LATEST.alfredworkflow" >> $GITHUB_OUTPUT
          else
            VERSION="${{ github.event.inputs.alfredo_version }}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "download_url=https://github.com/giovannicoppola/AlfreDo/releases/download/v$VERSION/AlfreDo_$VERSION.alfredworkflow" >> $GITHUB_OUTPUT
          fi

      - name: Download AlfreDo
        run: |
          mkdir -p build/alfredo-original
          curl -L "${{ steps.alfredo_release.outputs.download_url }}" -o build/alfredo-original.alfredworkflow
          unzip -q build/alfredo-original.alfredworkflow -d build/alfredo-original

      - name: Apply Toggl modifications
        run: |
          python3 alfredo-modifications/apply-modifications.py \
            build/alfredo-original \
            alfredo-modifications

      - name: Package modified workflow
        run: |
          cd build/alfredo-original
          zip -r ../AlfreDo-Toggl.alfredworkflow . -x "*.DS_Store"
          cd ../..

      - name: Check if release exists
        id: check_release
        run: |
          VERSION="${{ steps.alfredo_release.outputs.version }}"
          TAG="alfredo-toggl-v${VERSION}"
          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "tag=$TAG" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "tag=$TAG" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Create or update release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ steps.alfredo_release.outputs.version }}"
          TAG="${{ steps.check_release.outputs.tag }}"

          if [ "${{ steps.check_release.outputs.exists }}" == "true" ]; then
            echo "Updating existing release $TAG"
            gh release upload "$TAG" build/AlfreDo-Toggl.alfredworkflow --clobber
          else
            echo "Creating new release $TAG"
            gh release create "$TAG" \
              --title "AlfreDo-Toggl v${VERSION}" \
              --notes "Modified AlfreDo v${VERSION} with Toggl integration

## Added Features
- **‚åò‚Ü©Ô∏è (cmd-enter)**: Copy task name to clipboard üìã
- **‚å•‚Ü©Ô∏è (option-enter)**: Start Toggl timer with project inference ‚è±Ô∏è

## Base Version
- AlfreDo v${VERSION}

## Modifications
This workflow includes automated Toggl integration modifications. See [alfredo-modifications/](https://github.com/${{ github.repository }}/tree/master/alfredo-modifications) for details." \
              build/AlfreDo-Toggl.alfredworkflow
          fi
