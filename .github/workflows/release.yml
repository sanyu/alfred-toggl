name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Build Toggl-Timer workflow
        run: |
          mkdir -p dist

          # Extract version from tag (v1.1.0 -> 1.1.0)
          TAG_VERSION=${GITHUB_REF#refs/tags/v}

          # Build Toggl-Timer workflow
          cd Toggl-Timer.alfredworkflow
          zip -r "../dist/Toggl-Timer-${TAG_VERSION}.alfredworkflow" .
          cd ..

      - name: Download and build AlfreDo-Toggl workflow
        run: |
          # Get latest AlfreDo release
          LATEST_TAG=$(curl -s https://api.github.com/repos/giovannicoppola/AlfreDo/releases/latest | jq -r '.tag_name')
          ALFREDO_VERSION=${LATEST_TAG#v}

          # Download AlfreDo
          mkdir -p build/alfredo-original
          curl -L "https://github.com/giovannicoppola/AlfreDo/releases/download/$LATEST_TAG/AlfreDo_$ALFREDO_VERSION.alfredworkflow" \
            -o build/alfredo-original.alfredworkflow
          unzip -q build/alfredo-original.alfredworkflow -d build/alfredo-original

          # Apply Toggl modifications
          python3 alfredo-modifications/apply-modifications.py \
            build/alfredo-original \
            alfredo-modifications

          # Package modified workflow with version
          cd build/alfredo-original
          zip -r "../../dist/AlfreDo-${ALFREDO_VERSION}-Toggl.alfredworkflow" . -x "*.DS_Store"
          cd ../..

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*.alfredworkflow
          generate_release_notes: true
